<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Arquivos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #4a4a4a;
            margin-bottom: 20px;
        }
        .auth-container, .file-actions, .item-list-container {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        .auth-container label, .auth-container input, .auth-container button {
            display: block;
            width: 100%;
            box-sizing: border-box;
        }
        .auth-container input {
            padding: 10px;
            margin-top: 8px;
            margin-bottom: 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        .btn-primary {
            background-color: #007BFF;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-success {
            background-color: #28a745;
        }
        .btn-success:hover {
            background-color: #218838;
        }
        .btn-danger {
            background-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #333;
        }
        .btn-warning:hover {
            background-color: #e0a800;
        }
        .file-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .file-actions input[type="file"], .file-actions input[type="text"] {
            flex-grow: 1;
        }
        .file-actions .btn {
            flex-grow: 0;
        }
        .item-list {
            list-style: none;
            padding: 0;
            margin: 0;
            border: 1px solid #eee;
            border-radius: 8px;
        }
        .list-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s ease;
        }
        .list-item:hover {
            background-color: #f9f9f9;
        }
        .list-item .icon {
            margin-right: 15px;
            font-size: 1.5em;
            color: #666;
        }
        .list-item .item-info {
            flex-grow: 1;
        }
        .list-item .item-name {
            font-weight: bold;
            color: #444;
        }
        .item-list-actions {
            display: flex;
            gap: 5px;
        }
        .item-list-actions .btn {
            padding: 5px 10px;
            font-size: 0.8em;
        }
        #path-display {
            padding: 10px;
            font-weight: bold;
            color: #555;
            background: #e9ecef;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        #message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            display: none;
        }
        .message-success {
            background-color: #d4edda;
            color: #155724;
        }
        .message-error {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Gerenciador de Arquivos</h1>
        
        <div class="auth-container">
            <h2>Autentica√ß√£o</h2>
            <label for="token-input">Token JWT:</label>
            <input type="text" id="token-input" placeholder="Cole seu token de autentica√ß√£o aqui...">
            <button class="btn btn-primary" onclick="saveToken()">Salvar Token</button>
        </div>

        <div class="file-actions">
            <h2>A√ß√µes</h2>
            <input type="text" id="new-folder-name" placeholder="Nome da nova pasta...">
            <button class="btn btn-success" onclick="createFolder()">Criar Pasta</button>
            
            <input type="file" id="upload-file-input">
            <button class="btn btn-primary" onclick="uploadFile()">Upload de Arquivo</button>
        </div>

        <div class="item-list-container">
            <div id="path-display">Caminho: /</div>
            <div id="loading" style="text-align: center; display: none;">Carregando...</div>
            <div id="message"></div>
            <ul id="item-list" class="item-list">
                </ul>
        </div>
    </div>

    <script>
        const BASE_URL = 'http://localhost:8082';
        let token = localStorage.getItem('jwtToken');
        let currentPath = [];
        let currentFolderId = null;

        // Fun√ß√£o para salvar o token JWT
        function saveToken() {
            token = document.getElementById('token-input').value;
            localStorage.setItem('jwtToken', token);
            showMessage('Token salvo com sucesso! üîë', 'success');
        }

        // Fun√ß√£o para mostrar mensagens de sucesso/erro
        function showMessage(msg, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = msg;
            messageDiv.className = `message-${type}`;
            messageDiv.style.display = 'block';
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }

        // Fun√ß√£o para atualizar o cabe√ßalho de autentica√ß√£o
        function getAuthHeaders() {
            if (!token) {
                showMessage('Erro: Token de autentica√ß√£o n√£o encontrado.', 'error');
                return {};
            }
            return {
                'Authorization': `Bearer ${token}`
            };
        }

        // --- Fun√ß√µes de Requisi√ß√£o baseadas nos Endpoints ---

        // Lista pastas e arquivos
        async function loadContent(folderId = null) {
            const url = folderId === null ? `${BASE_URL}/api/pastas/raiz` : `${BASE_URL}/api/arquivos/pasta/${folderId}`;
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            document.getElementById('item-list').innerHTML = '';

            try {
                const response = await fetch(url, { headers: getAuthHeaders() });
                loading.style.display = 'none';

                if (response.status === 401) {
                    showMessage('N√£o autorizado. Verifique seu token.', 'error');
                    return;
                }
                if (!response.ok) {
                    throw new Error('Falha ao carregar conte√∫do. Erro no servidor.');
                }
                
                let data = await response.json();
                
                // Se a requisi√ß√£o for para a pasta, o endpoint `/api/arquivos/pasta/{id}` retorna um objeto com a chave "content"
                if (folderId !== null) {
                    const pastasResponse = await fetch(`${BASE_URL}/api/pastas/arvore`, { 
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            ...getAuthHeaders()
                        },
                        body: JSON.stringify({ idPastaPai: folderId })
                    });
                    const subpastas = await pastasResponse.json();
                    
                    data = {
                        pastas: subpastas,
                        arquivos: data.content
                    };
                }

                renderItems(data, folderId);

            } catch (error) {
                showMessage(`Erro: ${error.message}`, 'error');
            }
        }

        // Cria uma nova pasta
        async function createFolder() {
            const newFolderName = document.getElementById('new-folder-name').value;
            if (!newFolderName) {
                showMessage('O nome da pasta n√£o pode estar vazio.', 'error');
                return;
            }

            const payload = {
                nomePasta: newFolderName,
                idPastaPai: currentFolderId
            };

            try {
                const response = await fetch(`${BASE_URL}/api/pastas`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error('Erro ao criar pasta.');

                showMessage('Pasta criada com sucesso!', 'success');
                loadContent(currentFolderId);
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }

        // Upload de um arquivo
        async function uploadFile() {
            const fileInput = document.getElementById('upload-file-input');
            const file = fileInput.files[0];
            if (!file) {
                showMessage('Selecione um arquivo para upload.', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('pastaId', currentFolderId || '');

            try {
                const response = await fetch(`${BASE_URL}/api/arquivos/upload`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: formData
                });
                if (!response.ok) throw new Error('Erro ao fazer upload do arquivo.');

                showMessage('Arquivo enviado com sucesso!', 'success');
                loadContent(currentFolderId);
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }

        // Mover arquivo
        async function moveFile(fileId) {
            const newFolderId = prompt('Digite o ID da pasta de destino:');
            if (!newFolderId) return;

            try {
                const response = await fetch(`${BASE_URL}/api/arquivos/${fileId}/mover/${newFolderId}`, {
                    method: 'PUT',
                    headers: getAuthHeaders()
                });
                if (!response.ok) throw new Error('Erro ao mover o arquivo.');
                showMessage('Arquivo movido com sucesso!', 'success');
                loadContent(currentFolderId);
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }

        // Excluir arquivo
        async function deleteFile(fileId) {
            if (!confirm('Tem certeza que deseja excluir este arquivo?')) return;
            try {
                const response = await fetch(`${BASE_URL}/api/arquivos/${fileId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                if (!response.ok) throw new Error('Erro ao excluir o arquivo.');
                showMessage('Arquivo exclu√≠do com sucesso!', 'success');
                loadContent(currentFolderId);
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }

        // Renomear pasta
        async function renameFolder(pastaId) {
            const novoNome = prompt('Digite o novo nome para a pasta:');
            if (!novoNome) return;
            try {
                const response = await fetch(`${BASE_URL}/api/pastas/${pastaId}/renomear`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({ novoNome })
                });
                if (!response.ok) throw new Error('Erro ao renomear a pasta.');
                showMessage('Pasta renomeada com sucesso!', 'success');
                loadContent(currentFolderId);
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }

        // Download de arquivo
        function downloadFile(fileId) {
            window.location.href = `${BASE_URL}/api/arquivos/download/arquivo/${fileId}`;
        }

        // Excluir pasta
        async function deleteFolder(pastaId) {
            if (!confirm('Tem certeza que deseja excluir esta pasta e todo o seu conte√∫do?')) return;
            try {
                const response = await fetch(`${BASE_URL}/api/pastas/${pastaId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                if (!response.ok) throw new Error('Erro ao excluir a pasta.');
                showMessage('Pasta exclu√≠da com sucesso!', 'success');
                goBack();
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }
        
        // Navega√ß√£o de pastas
        function navigateTo(id, name) {
            currentPath.push({ id: currentFolderId, name: document.getElementById('path-display').textContent.split(': ')[1].trim() });
            currentFolderId = id;
            loadContent(id);
            updatePathDisplay(name);
        }

        // Renderiza itens na lista
        function renderItems(data, folderId) {
            const listContainer = document.getElementById('item-list');
            listContainer.innerHTML = '';
            
            let pastas = data;
            let arquivos = [];
            
            // L√≥gica para separar pastas e arquivos
            if (folderId !== null) {
                pastas = data.pastas;
                arquivos = data.arquivos;
            }

            if (folderId !== null) {
                const backItem = document.createElement('li');
                backItem.className = 'list-item';
                backItem.innerHTML = `<span class="icon">üîô</span><div class="item-info"><div class="item-name">.. Voltar</div></div>`;
                backItem.onclick = () => goBack();
                listContainer.appendChild(backItem);
            }

            pastas.forEach(item => {
                const li = document.createElement('li');
                li.className = 'list-item';
                
                li.innerHTML = `
                    <span class="icon">üìÅ</span>
                    <div class="item-info">
                        <div class="item-name">${item.nomePasta}</div>
                    </div>
                    <div class="item-list-actions">
                        <button class="btn btn-warning" onclick="event.stopPropagation(); renameFolder(${item.id})">Renomear</button>
                        <button class="btn btn-danger" onclick="event.stopPropagation(); deleteFolder(${item.id})">Excluir</button>
                    </div>
                `;
                li.onclick = () => navigateTo(item.id, item.nomePasta);
                listContainer.appendChild(li);
            });

            arquivos.forEach(item => {
                const li = document.createElement('li');
                li.className = 'list-item';
                
                li.innerHTML = `
                    <span class="icon">üìÑ</span>
                    <div class="item-info">
                        <div class="item-name">${item.nomeArquivo}</div>
                    </div>
                    <div class="item-list-actions">
                        <button class="btn btn-primary" onclick="event.stopPropagation(); downloadFile(${item.id})">Baixar</button>
                        <button class="btn btn-danger" onclick="event.stopPropagation(); deleteFile(${item.id})">Excluir</button>
                    </div>
                `;
                listContainer.appendChild(li);
            });
        }

        function updatePathDisplay(name) {
            const pathDisplay = document.getElementById('path-display');
            let pathText = currentPath.map(p => p.name).join(' / ');
            if (pathText) {
                pathText += ' / ';
            }
            pathText += name;
            pathDisplay.textContent = `Caminho: ${pathText}`;
        }

        function goBack() {
            if (currentPath.length > 0) {
                const previousFolder = currentPath.pop();
                currentFolderId = previousFolder.id;
                loadContent(currentFolderId);
            }
        }
        
        // Chamada inicial
        loadContent();

    </script>
</body>
</html>