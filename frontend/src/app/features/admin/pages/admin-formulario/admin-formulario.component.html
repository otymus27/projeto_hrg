<div class="explorer-container card shadow-sm">
  <div class="card-body p-4">
    <!-- Cabe√ßalho -->
    <div
      class="d-flex justify-content-between align-items-center bg-dark text-white p-3 rounded mb-3"
    >
      <h1>Gerenciador de Formul√°rios</h1>
      
    </div>

    <!-- Breadcrumb -->
    <nav class="breadcrumb mt-3 mb-3">
      <span
        class="breadcrumb-item text-primary"
        style="cursor: pointer"
        (click)="navegarPara(-1)"
        >Raiz</span
      >
      <ng-container *ngFor="let pasta of breadcrumb; let i = index">
        <span class="breadcrumb-separator mx-2">/</span>
        <span
          class="breadcrumb-item text-primary"
          style="cursor: pointer"
          (click)="navegarPara(i)"
        >
          {{ pasta.nomePasta }}
        </span>
      </ng-container>
    </nav>

    <!-- Bot√µes de a√ß√µes -->
    <div class="mb-3 d-flex align-items-center gap-2">
      <button
        class="btn btn-outline-secondary"
        (click)="voltarUmNivel()"
        [disabled]="breadcrumb.length === 0"
      >
        <i class="bi bi-arrow-left"></i> Voltar
      </button>
      <button
        class="btn btn-sm btn-danger"
        [disabled]="itensSelecionados.length === 0"
        (click)="abrirModalExcluirSelecionados()"
      >
        Excluir Selecionados ({{ itensSelecionados.length }})
      </button>

      <!-- Bot√£o Nova Pasta s√≥ aparece quando N√ÉO est√° dentro de uma pasta -->
      <button
        class="btn btn-primary btn-rounded btn-shadow"
        (click)="abrirModalCriarPasta()"
        *ngIf="!obterPastaAtual()"
      >
        <i class="bi bi-folder-plus me-1"></i> Nova Pasta
      </button>
      <!-- Upload s√≥ aparece dentro de uma pasta -->
      <button
        class="btn btn-success btn-rounded btn-shadow"
        (click)="abrirModalUpload()"
        *ngIf="obterPastaAtual()"
      >
        <i class="bi bi-upload me-1"></i> Upload
      </button>
    </div>

    <!-- Loading -->
    <div *ngIf="loading" class="text-center my-3">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2">Carregando conte√∫do...</p>
    </div>

    <!-- Lista de conte√∫do -->
    <div class="lista-scrollable" *ngIf="!loading">
      <table class="table table-hover mb-0">
        <thead>
          <tr>
            <th style="width: 40px">
              <input
                type="checkbox"
                [checked]="
                  todosItens.length > 0 &&
                  itensSelecionados.length === todosItens.length
                "
                (change)="
                  itensSelecionados.length === todosItens.length
                    ? desmarcarTodos()
                    : marcarTodos()
                "
              />
            </th>
            <th (click)="ordenarPor('nomePasta')" style="cursor:pointer">Nome</th>
            <th (click)="ordenarPor('tamanho')" style="cursor:pointer">Tamanho</th>
            <th (click)="ordenarPor('dataUpload')" style="cursor:pointer">Data Upload</th>
            
          </tr>
        </thead>
        <tbody>
          <!-- Subpastas -->
          <tr *ngFor="let pasta of pastas">
            <td>
              <input
                type="checkbox"
                [checked]="isSelecionado(pasta)"
                (change)="toggleSelecao(pasta)"
              />
            </td>
            <td
              class="text-primary fw-bold"
              style="cursor: pointer"
              (click)="abrirPasta(pasta)"
            >
              üìÅ {{ pasta.nomePasta }}
            </td>
            <td>--</td>
            <td>--</td>
            <td class="text-end">
              <button
                class="btn btn-warning btn-sm me-1"
                (click)="abrirModalRenomear(pasta)"
              >
                <i class="bi bi-pencil-square"></i>
              </button>
              <button
                class="btn btn-danger btn-sm"
                (click)="abrirModalExcluir(pasta)"
              >
                <i class="bi bi-trash"></i>
              </button>
            </td>
          </tr>

          <!-- Arquivos -->
          <tr *ngFor="let arquivo of arquivos">
            <td>
              <input
                type="checkbox"
                [checked]="isSelecionado(arquivo)"
                (change)="toggleSelecao(arquivo)"
              />
            </td>
            <td (click)="abrirOpcoesArquivo(arquivo)" style="cursor: pointer">
              üìÑ {{ arquivo.nomeArquivo }}
            </td>
            <td>{{ formulariosService.formatarTamanho(arquivo.tamanho) }}</td>
            <td>{{ arquivo.dataUpload | date : "dd/MM/yyyy HH:mm" }}</td>
            <td class="text-end">
              <button
                class="btn btn-success btn-sm me-1"
                (click)="
                  formulariosService.downloadFormulario(arquivo.id).subscribe()
                "
              >
                <i class="bi bi-download"></i>
              </button>
              <button
                class="btn btn-warning btn-sm me-1"
                (click)="abrirModalRenomear(arquivo)"
              >
                <i class="bi bi-pencil-square"></i>
              </button>
              <button
                class="btn btn-danger btn-sm"
                (click)="abrirModalExcluir(arquivo)"
              >
                <i class="bi bi-trash"></i>
              </button>
            </td>
          </tr>

          <!-- Estado vazio -->
          <tr *ngIf="pastas.length === 0 && arquivos.length === 0">
            <td colspan="5" class="text-center text-muted">
              Nenhuma subpasta ou arquivo encontrado nesta pasta.
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal Op√ß√µes de Arquivo -->
<div class="modal-backdrop" *ngIf="modalOpcoesArquivoAberto">
  <div class="modal-custom">
    <h3>Arquivo: {{ arquivoSelecionado?.nomeArquivo }}</h3>
    <p>O que deseja fazer?</p>
    <div class="text-end">
      <button
        class="btn btn-primary me-2"
        (click)="visualizarArquivo(arquivoSelecionado!)"
      >
        <i class="bi bi-eye"></i> Visualizar
      </button>
      <button
        class="btn btn-success me-2"
        (click)="downloadArquivo(arquivoSelecionado!)"
      >
        <i class="bi bi-download"></i> Baixar
      </button>
      <button class="btn btn-secondary" (click)="fecharModalOpcoesArquivo()">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- Criar Pasta -->
<div class="modal-backdrop" *ngIf="modalCriarPastaAberto">
  <div class="modal-custom">
    <h3>Criar Nova Pasta</h3>
    <input
      type="text"
      [(ngModel)]="novoNomePasta"
      (input)="novoNomePasta = (novoNomePasta || '').toUpperCase()"
      placeholder="Nome da pasta"
      class="form-control mb-3"
    />
    <div class="text-end">
      <button class="btn btn-primary me-2" (click)="criarPasta()">
        Salvar
      </button>
      <button class="btn btn-secondary" (click)="fecharModalCriarPasta()">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- Renomear -->
<div class="modal-backdrop" *ngIf="modalRenomearAberto">
  <div class="modal-custom">
    <h3>Renomear</h3>
    <input type="text" [(ngModel)]="novoNomeItem"
    (input)="novoNomeItem = (novoNomeItem || '').toUpperCase()"
    class="form-control mb-3" />
    <div class="text-end">
      <button class="btn btn-primary me-2" (click)="renomearItem()">
        Salvar
      </button>
      <button class="btn btn-secondary" (click)="fecharModalRenomear()">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- Upload -->
<div class="modal-backdrop" *ngIf="modalUploadAberto">
  <div class="modal-custom">
    <h3>Upload de Arquivos</h3>
    <input
      type="file"
      (change)="onArquivosSelecionados($event)"
      multiple
      class="form-control mb-3"
    />
    <ul class="list-group mb-3">
      <li
        *ngFor="let f of arquivosParaUpload"
        class="list-group-item d-flex justify-content-between"
      >
        {{ f.name }}
        <button
          class="btn btn-danger btn-sm"
          (click)="removerArquivoSelecionado(f)"
        >
          Remover
        </button>
      </li>
    </ul>
    <div class="text-end">
      <button class="btn btn-primary me-2" (click)="uploadArquivos()">
        Enviar
      </button>
      <button class="btn btn-secondary" (click)="fecharModalUpload()">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- Excluir -->
<div class="modal-backdrop" *ngIf="modalExcluirAberto">
  <div class="modal-custom">
    <h3>Confirma Exclus√£o</h3>
    <p>
      Deseja realmente excluir <b>{{ getNomeItem(itemParaExcluir) }}</b
      >?
    </p>
    <div class="text-end">
      <button class="btn btn-danger me-2" (click)="confirmarExclusao()">
        Excluir
      </button>
      <button class="btn btn-secondary" (click)="fecharModalExcluir()">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- Excluir Selecionados -->
<div class="modal-backdrop" *ngIf="modalExcluirSelecionadosAberto">
  <div class="modal-custom">
    <h3>Excluir Itens Selecionados</h3>
    <p>
      Deseja excluir os itens selecionados ({{ itensSelecionados.length }})?
    </p>
    <div class="text-end">
      <button
        class="btn btn-danger me-2"
        (click)="confirmarExclusaoSelecionados()"
      >
        Excluir
      </button>
      <button
        class="btn btn-secondary"
        (click)="fecharModalExcluirSelecionados()"
      >
        Cancelar
      </button>
    </div>
  </div>
</div>
