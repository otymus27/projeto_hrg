<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de API de Pastas Privadas</title>
    <!-- Inclui o Tailwind CSS para estilização rápida -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inclui Font Awesome para ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .folder-icon {
            transition: transform 0.2s;
        }
        .folder-icon.open {
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white rounded-xl shadow-lg p-6 max-w-4xl w-full">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Testador de Pastas Privadas</h1>

        <!-- Seção de autenticação -->
        <div class="mb-6">
            <p class="text-sm text-gray-600 mb-2">Insira seu token JWT para autenticar:</p>
            <div class="flex items-center space-x-2">
                <input type="text" id="tokenInput" class="flex-1 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Cole o token JWT aqui">
                <button id="connectBtn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">Conectar</button>
            </div>
            <div class="flex items-center mt-2">
                <input type="checkbox" id="rememberToken" class="rounded text-blue-600 focus:ring-blue-500">
                <label for="rememberToken" class="ml-2 text-sm text-gray-600">Lembrar token</label>
            </div>
            <div id="statusMessage" class="mt-2 text-center text-sm font-medium"></div>
        </div>

        <!-- Seção de navegação e listagem de arquivos -->
        <div id="fileBrowser" class="hidden">
            <div class="flex items-center justify-between mb-4">
                <span id="currentPath" class="text-gray-700 text-lg font-semibold">/</span>
                <div class="flex space-x-2">
                    <button id="backToRootBtn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300">
                        <i class="fas fa-home mr-2"></i> Raiz
                    </button>
                    <button id="backBtn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300">
                        <i class="fas fa-arrow-left mr-2"></i> Anterior
                    </button>
                </div>
            </div>
            
            <!-- Tabela de arquivos com barra de rolagem horizontal -->
            <div class="bg-gray-50 rounded-lg overflow-x-auto border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tamanho</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="fileTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Arquivos e pastas serão inseridos aqui via JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal para download/visualização -->
    <div id="actionModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div class="relative p-6 bg-white w-96 max-w-full m-auto rounded-xl shadow-lg">
            <h2 class="text-xl font-bold mb-4">Selecione uma ação</h2>
            <p id="modalFileName" class="mb-4 text-gray-600"></p>
            <div class="flex justify-end space-x-4">
                <button id="viewBtn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300">
                    <i class="fas fa-eye mr-2"></i> Visualizar
                </button>
                <button id="downloadBtn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">
                    <i class="fas fa-download mr-2"></i> Download
                </button>
                <button id="cancelBtn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300">
                    <i class="fas fa-times mr-2"></i> Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Novo Modal para Renomear -->
    <div id="renameModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div class="relative p-6 bg-white w-96 max-w-full m-auto rounded-xl shadow-lg">
            <h2 class="text-xl font-bold mb-4">Renomear</h2>
            <p id="renameModalText" class="mb-4 text-gray-600"></p>
            <input type="text" id="newFilenameInput" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
            <div class="flex justify-end space-x-4">
                <button id="renameConfirmBtn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300">
                    <i class="fas fa-check mr-2"></i> Confirmar
                </button>
                <button id="renameCancelBtn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300">
                    <i class="fas fa-times mr-2"></i> Cancelar
                </button>
            </div>
        </div>
    </div>


    <script>
        // O URL base da sua API
        const API_BASE_URL = 'http://localhost:8082/api/privado/pastas';

        // Elementos da UI
        const tokenInput = document.getElementById('tokenInput');
        const connectBtn = document.getElementById('connectBtn');
        const rememberTokenCheckbox = document.getElementById('rememberToken');
        const backToRootBtn = document.getElementById('backToRootBtn');
        const backBtn = document.getElementById('backBtn');
        const statusMessage = document.getElementById('statusMessage');
        const fileBrowser = document.getElementById('fileBrowser');
        const fileTableBody = document.getElementById('fileTableBody');
        const currentPathSpan = document.getElementById('currentPath');
        const actionModal = document.getElementById('actionModal');
        const modalFileName = document.getElementById('modalFileName');
        const viewBtn = document.getElementById('viewBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const renameModal = document.getElementById('renameModal');
        const renameModalText = document.getElementById('renameModalText');
        const newFilenameInput = document.getElementById('newFilenameInput');
        const renameConfirmBtn = document.getElementById('renameConfirmBtn');
        const renameCancelBtn = document.getElementById('renameCancelBtn');

        // Variável para rastrear o caminho atual e o item selecionado
        let currentDirectory = '';
        let selectedFilePath = '';
        let selectedFileName = '';
        let isSelectedFolder = false;
        let selectedItemId = null; // Novo para armazenar o ID do item

        // Carrega o token salvo ao iniciar
        document.addEventListener('DOMContentLoaded', () => {
            const savedToken = localStorage.getItem('jwtToken');
            if (savedToken) {
                tokenInput.value = savedToken;
                rememberTokenCheckbox.checked = true;
                // Opcional: conectar automaticamente se o token estiver presente
                // fetchFiles();
            }
        });

        // Exibe mensagens de status na tela
        function showMessage(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = 'mt-2 text-center text-sm font-medium';
            if (type === 'success') {
                statusMessage.classList.add('text-green-600');
            } else if (type === 'error') {
                statusMessage.classList.add('text-red-600');
            } else {
                statusMessage.classList.add('text-gray-600');
            }
        }

        // Faz a requisição para listar os arquivos
        async function fetchFiles(path = '') {
            const token = tokenInput.value;
            if (!token) {
                showMessage('Por favor, insira um token JWT.', 'error');
                return;
            }

            // Salva o token se o checkbox estiver marcado
            if (rememberTokenCheckbox.checked) {
                localStorage.setItem('jwtToken', token);
            } else {
                localStorage.removeItem('jwtToken');
            }

            showMessage('Carregando...', 'info');
            fileTableBody.innerHTML = '';
            currentPathSpan.textContent = path === '' ? '/' : `/${path}`;
            currentDirectory = path;

            try {
                const response = await fetch(`${API_BASE_URL}?caminho=${encodeURIComponent(path)}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erro ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                renderTable(data);
                showMessage('Conectado e arquivos carregados com sucesso!', 'success');
                fileBrowser.classList.remove('hidden');

            } catch (error) {
                showMessage(`Erro ao carregar arquivos: ${error.message}`, 'error');
                fileBrowser.classList.add('hidden');
            }
        }

        /**
         * Renderiza a tabela de arquivos.
         * Assumes que o JSON retornado inclui um campo 'id' para cada item.
         */
        function renderTable(items) {
            fileTableBody.innerHTML = '';

            // Adiciona a opção "Voltar"
            if (currentDirectory !== '') {
                const tr = document.createElement('tr');
                tr.className = 'cursor-pointer hover:bg-gray-100 transition duration-200';
                tr.dataset.path = '..';
                tr.dataset.isDirectory = 'true';
                tr.innerHTML = `
                    <td colspan="3" class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600">
                        <i class="fas fa-level-up-alt mr-2"></i> ...
                    </td>
                `;
                fileTableBody.appendChild(tr);
            }

            if (!items || items.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="3" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Este diretório está vazio.</td>`;
                fileTableBody.appendChild(tr);
                return;
            }

            items.forEach(item => {
                const itemPath = currentDirectory ? `${currentDirectory}/${item.nome}` : item.nome;
                
                const tr = document.createElement('tr');
                tr.className = 'cursor-pointer hover:bg-gray-100 transition duration-200';
                tr.dataset.path = itemPath;
                tr.dataset.isDirectory = item.isDiretorio;
                tr.dataset.name = item.nome;
                tr.dataset.id = item.id; // Salva o ID do item na linha da tabela

                const icon = item.isDiretorio ? 'fas fa-folder text-blue-500' : 'fas fa-file text-gray-500';
                const size = item.isDiretorio ? '-' : `${item.tamanho.toFixed(2)} KB`;

                // O ID (item.id) é OBRIGATÓRIO para a função de renomear.
                // O botão de renomear só será exibido se o 'item.id' for um valor válido.
                const renameButton = item.id ? `
                    <button onclick="event.stopPropagation(); showRenameModal('${itemPath}', '${item.nome}', '${item.id}')" class="text-yellow-600 hover:text-yellow-900 transition duration-200" title="Renomear">
                        <i class="fas fa-edit"></i>
                    </button>
                ` : '';

                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        <i class="${icon} mr-2"></i> ${item.nome}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${size}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <div class="flex justify-end space-x-2">
                            <button onclick="event.stopPropagation(); showModal('${itemPath}', '${item.nome}', ${item.isDiretorio})" class="text-blue-600 hover:text-blue-900 transition duration-200" title="Download">
                                <i class="fas fa-download"></i>
                            </button>
                            ${renameButton}
                            <button onclick="event.stopPropagation(); alert('Excluir ação para ${item.nome}')" class="text-red-600 hover:text-red-900 transition duration-200" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                fileTableBody.appendChild(tr);
            });
        }
        
        // Exibe o modal de download/visualização
        function showModal(filePath, fileName, isDirectory) {
            selectedFilePath = filePath;
            selectedFileName = fileName;
            isSelectedFolder = isDirectory;

            modalFileName.textContent = `O que você gostaria de fazer com "${fileName}"?`;

            // Configura os botões do modal
            if (isSelectedFolder) {
                viewBtn.classList.add('hidden');
                downloadBtn.textContent = 'Baixar Pasta';
                downloadBtn.classList.add('px-8');
            } else {
                viewBtn.classList.remove('hidden');
                downloadBtn.textContent = 'Download';
                downloadBtn.classList.remove('px-8');
            }

            actionModal.classList.remove('hidden');
        }

        // Exibe o modal para renomear
        function showRenameModal(filePath, fileName, itemId) {
            selectedFilePath = filePath;
            selectedFileName = fileName;
            selectedItemId = itemId; // Armazena o ID para uso na requisição

            renameModalText.textContent = `Renomear "${fileName}" para:`;
            newFilenameInput.value = fileName;
            renameModal.classList.remove('hidden');
            newFilenameInput.focus();
        }

        // Renomeia o arquivo ou pasta
        async function renameItem() {
            const token = tokenInput.value;
            const newName = newFilenameInput.value.trim();

            if (!token) {
                showMessage('Por favor, insira um token JWT.', 'error');
                renameModal.classList.add('hidden');
                return;
            }

            if (!newName) {
                showMessage('O novo nome não pode estar vazio.', 'error');
                return;
            }

            // Validação mais robusta para garantir que o ID não é nulo ou indefinido
            if (!selectedItemId || selectedItemId === 'undefined') {
                showMessage('ID do item não encontrado. Não é possível renomear.', 'error');
                renameModal.classList.add('hidden');
                return;
            }

            showMessage('Renomeando...', 'info');

            try {
                // Requisição PATCH usando o ID no caminho e o novo nome no corpo
                const response = await fetch(`${API_BASE_URL}/${selectedItemId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        nome: newName // Envia apenas o campo de nome
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erro ao renomear: ${response.status} - ${errorText}`);
                }

                showMessage('Item renomeado com sucesso!', 'success');
                fetchFiles(currentDirectory); // Atualiza a lista de arquivos
            } catch (error) {
                showMessage(`Erro: ${error.message}`, 'error');
            } finally {
                renameModal.classList.add('hidden');
            }
        }


        // Gerencia os cliques na tabela
        function handleTableClick(event) {
            const tr = event.target.closest('tr');
            if (!tr) return;

            const isDirectory = tr.dataset.isDirectory === 'true';
            const itemPath = tr.dataset.path;
            const itemName = tr.dataset.name;

            if (isDirectory) {
                if (itemPath === '..') {
                    // Navega para o diretório pai
                    const pathSegments = currentDirectory.split('/');
                    pathSegments.pop();
                    const newPath = pathSegments.join('/');
                    fetchFiles(newPath);
                } else {
                    // Navega para o subdiretório
                    fetchFiles(itemPath);
                }
            } else {
                // Para arquivos, exibe o modal
                showModal(itemPath, itemName, isDirectory);
            }
        }
        
        /**
         * Faz o download do arquivo usando fetch e blob.
         * Isso permite enviar o token de autenticação.
         */
        async function downloadFile(path, filename) {
            const token = tokenInput.value;
            if (!token) {
                showMessage('Por favor, insira um token JWT.', 'error');
                return;
            }

            showMessage('Iniciando download...', 'info');

            try {
                const response = await fetch(`${API_BASE_URL}/download?caminho=${encodeURIComponent(path)}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erro ao baixar o arquivo: ${response.status} - ${errorText}`);
                }

                // Obtém o nome do arquivo do cabeçalho Content-Disposition, se disponível
                const contentDisposition = response.headers.get('Content-Disposition');
                let finalFilename = filename;
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename\*?=["']?(?:UTF-8'')?([^"']+)/);
                    if (filenameMatch && filenameMatch[1]) {
                        finalFilename = decodeURIComponent(filenameMatch[1]);
                    }
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = finalFilename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();

                showMessage('Download iniciado com sucesso!', 'success');

            } catch (error) {
                showMessage(`Erro: ${error.message}`, 'error');
            } finally {
                actionModal.classList.add('hidden');
            }
        }

        /**
         * Faz o download da pasta usando fetch e blob, assumindo que o back-end
         * retornará um arquivo comprimido.
         */
        async function downloadFolder(path) {
            const token = tokenInput.value;
            if (!token) {
                showMessage('Por favor, insira um token JWT.', 'error');
                return;
            }

            showMessage('Iniciando o download da pasta...', 'info');

            try {
                const response = await fetch(`${API_BASE_URL}/download-pasta?caminho=${encodeURIComponent(path)}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erro ao baixar a pasta: ${response.status} - ${errorText}`);
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                // Usa o nome da última parte do caminho como nome do arquivo zip
                const folderName = path.split('/').pop();
                a.download = `${folderName}.zip`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();

                showMessage('Download da pasta iniciado com sucesso!', 'success');

            } catch (error) {
                showMessage(`Erro: ${error.message}`, 'error');
            }
        }

        /**
         * Visualiza o arquivo no navegador em uma nova aba.
         */
        async function viewFile(path) {
            const token = tokenInput.value;
            if (!token) {
                showMessage('Por favor, insira um token JWT.', 'error');
                return;
            }

            showMessage('Abrindo visualização...', 'info');

            try {
                const response = await fetch(`${API_BASE_URL}/view?caminho=${encodeURIComponent(path)}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erro ao visualizar o arquivo: ${response.status} - ${errorText}`);
                }

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                window.open(url, '_blank');
                URL.revokeObjectURL(url);
                
                showMessage('Visualização aberta com sucesso!', 'success');

            } catch (error) {
                showMessage(`Erro: ${error.message}`, 'error');
            } finally {
                actionModal.classList.add('hidden');
            }
        }

        // Adiciona event listeners
        connectBtn.addEventListener('click', () => fetchFiles());
        fileTableBody.addEventListener('click', handleTableClick);
        backToRootBtn.addEventListener('click', () => fetchFiles(''));
        backBtn.addEventListener('click', () => {
            if (currentDirectory !== '') {
                const pathSegments = currentDirectory.split('/');
                pathSegments.pop();
                const newPath = pathSegments.join('/');
                fetchFiles(newPath);
            }
        });

        tokenInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                fetchFiles();
            }
        });
        
        downloadBtn.addEventListener('click', () => {
            if (isSelectedFolder) {
                downloadFolder(selectedFilePath);
            } else {
                downloadFile(selectedFilePath, selectedFileName);
            }
            actionModal.classList.add('hidden');
        });
        
        viewBtn.addEventListener('click', () => {
            viewFile(selectedFilePath);
        });

        cancelBtn.addEventListener('click', () => {
            actionModal.classList.add('hidden');
        });

        // Event listeners para o novo modal de renomear
        renameConfirmBtn.addEventListener('click', renameItem);
        renameCancelBtn.addEventListener('click', () => {
            renameModal.classList.add('hidden');
        });
        newFilenameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                renameItem();
            }
        });
    </script>
</body>
</html>
